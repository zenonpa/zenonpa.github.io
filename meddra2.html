 <!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>IndexedDB: Local Database with HTML5</title>

        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.min.css">
        <script type="text/javascript" src="//code.jquery.com/jquery-2.2.1.js"></script>
        <script type="text/javascript" src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
        <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>

        <script type="text/javascript">
            var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
            var dataBase = null;

            function startDB() {
                
                dataBase = indexedDB.open("meddra", 1);
                
                dataBase.onupgradeneeded = function (e) {
                
                    var active = dataBase.result;   
                    var object = active.createObjectStore('v18', { keyPath : 'id', autoIncrement : true });
                    object.createIndex('by_name', 'soc_code', { unique : false });

                    
                };
                
                dataBase.onsuccess = function (e) {
                    console.log('Database loaded');
                    loadAll2();
                };
                
                dataBase.onerror = function (e) {
                    alert('Error loading database');
                };

            }


                        

            function add() {
                
                var active = dataBase.result;
                var data = active.transaction(["v18"], "readwrite");
                var object = data.objectStore("v18");
                
                var request = object.put({
                    soc_order : document.querySelector("#soc_order").value,
                    soc_code : document.querySelector("#soc_code").value.toLowerCase(),
                    soc_name : document.querySelector("#soc_name").value,
                    pt_code : document.querySelector("#pt_code").value,
                    pt_name : document.querySelector("#pt_name").value,
                    llt_code : document.querySelector("#llt_code").value,
                    llt_name : document.querySelector("#llt_name").value
                });
                
                request.onerror = function (e) {
                    alert(request.error.name + '\n\n' + request.error.message);
                };
        
                data.oncomplete = function (e) {
                    document.querySelector('#soc_order').value = '';
                    document.querySelector('#soc_code').value = '';
                    document.querySelector('#soc_name').value = '';
                    document.querySelector('#pt_code').value = '';
                    document.querySelector('#pt_name').value = '';
                    document.querySelector('#llt_code').value = '';
                    document.querySelector('#llt_name').value = '';
                    console.log('Object successfully added');
                    //loadAll();
                };
            }
            
            function load(id) {
                
                var active = dataBase.result;
                var data = active.transaction(["v18"], "readonly");
                var object = data.objectStore("v18");
                
                var request = object.get(parseInt(id));
                
                request.onsuccess = function () {
                    
                    var result = request.result;
                    
                    if (result !== undefined) {
                        alert("ID: " + result.id + "\n\
                        soc_order: " + result.soc_order + "\n\
                        soc_code: " + result.soc_code + "\n\
                        soc_name: " + result.soc_name);
                    }
                };
                
            }
            
            function loadBySoc(soc_order) {
                
                var active = dataBase.result;
                var data = active.transaction(["v18"], "readonly");
                var object = data.objectStore("v18");
                var index = object.index("by_soc_order");
                
                var request = index.get(String(soc_order));
                
                request.onsuccess = function () {
                    
                    var result = request.result;
                    
                    if (result !== undefined) {
                        alert("ID: " + result.id + "\n\
                        soc_order: " + result.soc_order + "\n\
                        soc_code: " + result.soc_code + "\n\
                        soc_name: " + result.soc_name);
                    }
                };
                
            }
            
            function AddJSON(){
                    

              $.ajax({url: 'http://pvmedra2.azurewebsites.net/api/meddra/1' ,dataType: 'json', success: function(data) {   
                    addRegistros(data);                                      
                    }.bind(this),
                    error: function(xhr, status, err) {
                        console.error(this.props.url, status, err.toString());
                    }.bind(this)
                });              
            }
            function addRegistros(dat1){
                
                addRegistrosMain(JSON.stringify(dat1));
                
            }
            function addRegistrosMain(datos2){               
                var datos = JSON.parse(datos2);                
                var active = dataBase.result;
                var data = active.transaction(["v18"], "readwrite");
                var object = data.objectStore("v18");
                object.clear();
                var request = object.put(datos);
                
                request.onerror = function (e) {
                    alert(request.error.name + '\n\n' + request.error.message);
                };
        
                data.oncomplete = function (e) {
                    console.log('Object successfully added');
                    //loadAll();
                };
            }

            function loadAll2() {
                var active = dataBase.result;
                var data = active.transaction("v18", "readonly");
                var object = data.objectStore("v18");
                var myIndex = object.index('by_name');
                var countRequest = myIndex.count();
                countRequest.onsuccess = function() {
                    console.log(countRequest.result);
                }
                var arr = Object.keys(object).map(function(k) { return obj[k] });
                $('#example').DataTable( {
                    data: arr,
                    columns: [
                        { title: "SOC ORDER" },
                        { title: "SOC CODE" },
                        { title: "SOC NAME" },
                        { title: "PT CODE" },
                        { title: "PT NAME" },
                        { title: "LLT CODE" },
                        { title: "LLT NAME" }
                    ]
                } );

            }
            
            function loadAll() {
                
                var active = dataBase.result;
                var data = active.transaction(["v18"], "readonly");
                var object = data.objectStore("v18");
                
                var elements = [];
                
                object.openCursor().onsuccess = function (e) {
                    
                    var result = e.target.result;
                    console.log("result : ", result.value[0]);
                    if (result === null) {
                        return;
                    }
                    
                    for (var i in result.value){
                        elements.push(result.value[i]);
                    }
                        
                    
                    return;                        

                };
                
                data.oncomplete = function() {
                    
                    var outerHTML = '';
                    
                    for (var key in elements) {
                        
                        outerHTML += '\n\
                        <tr>\n\
                            <td>' + elements[key].soc_order + '</td>\n\
                            <td>' + elements[key].soc_code + '</td>\n\
                            <td>' + elements[key].soc_name + '</td>\n\
                            <td>' + elements[key].pt_code + '</td>\n\
                            <td>' + elements[key].pt_name + '</td>\n\
                            <td>' + elements[key].llt_code + '</td>\n\
                            <td>' + elements[key].llt_name + '</td>\n\
                            <td>\n\
                                <button type="button" onclick="load(' + elements[key].id + ');">Details</button>\n\
                                <button type="button" onclick="loadBySoc(' + elements[key].soc_order + ');">Details soc_order</button>\n\
                            </td>\n\
                        </tr>';                        
                    }
                    
                    elements = [];
                    document.querySelector("#elementsList").innerHTML = outerHTML;
                };
                
            }
            
            function loadAllByName() {
                
                var active = dataBase.result;
                var data = active.transaction(["v18"], "readonly");
                var object = data.objectStore("v18");
                var index = object.index('by_name');
                
                var elements = [];
                
                index.openCursor().onsuccess = function (e) {
                    
                    var result = e.target.result;
                    
                    if (result === null) {
                        return;
                    }
                    
                    elements.push(result.value);
                    result.continue();
                    
                };
                
                data.oncomplete = function() {
                    
                    var outerHTML = '';
                    
                    for (var key in elements) {
                        
                        outerHTML += '\n\
                        <tr>\n\
                            <td>' + elements[key].soc_order + '</td>\n\
                            <td>' + elements[key].soc_code + '</td>\n\
                            <td>' + elements[key].soc_name + '</td>\n\
                            <td>' + elements[key].pt_code + '</td>\n\
                            <td>' + elements[key].pt_name + '</td>\n\
                            <td>' + elements[key].llt_code + '</td>\n\
                            <td>' + elements[key].llt_name + '</td>\n\
                            <td>\n\
                                <button type="button" onclick="load(' + elements[key].id + ');">Details</button>\n\
                                <button type="button" onclick="loadBySoc(' + elements[key].soc_order + ');">Details soc_order</button>\n\
                            </td>\n\
                        </tr>';                        
                    }
                    
                    elements = [];
                    document.querySelector("#elementsList").innerHTML = outerHTML;
                };
                
            }

        </script>
    </head>
    <body onload="startDB();">
        <input type="text" id="soc_order" placeholder="Enter Soc Order" />
        <input type="text" id="soc_code" placeholder="Enter SOC code" />
        <input type="text" id="soc_name" placeholder="Enter SOC name" />
        <input type="text" id="pt_code" placeholder="Enter PT code" />
        <input type="text" id="pt_name" placeholder="Enter PT Name" />
        <input type="text" id="llt_code" placeholder="Enter LLT Code" />
        <input type="text" id="llt_name" placeholder="Enter LLT Name" />
        <button type="button" onclick="add();">Save</button>
        <button type="button" onclick="AddJSON();">Add JSON</button>
        <hr />
        <table id="example" class="display" width="100%"></table>

        <table id="example2" class="display" width="100%"></table>

        <div id="elements">
            <table>
                <caption>Meddra</caption>
                <thead>
                    <tr>
                        <th>Soc Order</th>
                        <th>Soc Code</th>
                        <th>Soc Name</th>
                        <th>PT Code</th>
                        <th>PT Name</th>
                        <th>LLT Code</th>
                        <th>LLT Name</th>
                        <th> </th>
                    </tr>
                </thead>
                <tbody id="elementsList">
                    <tr>
                        <td colspan="3">Not elements to show</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button type="button" onclick="loadAllByName();">Order by name</button>
       <script>
           var dataSet = [
               [ "Tiger Nixon", "System Architect", "Edinburgh", "5421", "2011/04/25", "$320,800" ],
               [ "Garrett Winters", "Accountant", "Tokyo", "8422", "2011/07/25", "$170,750" ],
               [ "Ashton Cox", "Junior Technical Author", "San Francisco", "1562", "2009/01/12", "$86,000" ],
               [ "Cedric Kelly", "Senior Javascript Developer", "Edinburgh", "6224", "2012/03/29", "$433,060" ],
               [ "Airi Satou", "Accountant", "Tokyo", "5407", "2008/11/28", "$162,700" ],
               [ "Brielle Williamson", "Integration Specialist", "New York", "4804", "2012/12/02", "$372,000" ],
               [ "Herrod Chandler", "Sales Assistant", "San Francisco", "9608", "2012/08/06", "$137,500" ],
               [ "Rhona Davidson", "Integration Specialist", "Tokyo", "6200", "2010/10/14", "$327,900" ],
               [ "Colleen Hurst", "Javascript Developer", "San Francisco", "2360", "2009/09/15", "$205,500" ],
               [ "Sonya Frost", "Software Engineer", "Edinburgh", "1667", "2008/12/13", "$103,600" ],
               [ "Jena Gaines", "Office Manager", "London", "3814", "2008/12/19", "$90,560" ],
               [ "Quinn Flynn", "Support Lead", "Edinburgh", "9497", "2013/03/03", "$342,000" ],
               [ "Charde Marshall", "Regional Director", "San Francisco", "6741", "2008/10/16", "$470,600" ],
               [ "Haley Kennedy", "Senior Marketing Designer", "London", "3597", "2012/12/18", "$313,500" ],
               [ "Tatyana Fitzpatrick", "Regional Director", "London", "1965", "2010/03/17", "$385,750" ],
               [ "Michael Silva", "Marketing Designer", "London", "1581", "2012/11/27", "$198,500" ],
               [ "Paul Byrd", "Chief Financial Officer (CFO)", "New York", "3059", "2010/06/09", "$725,000" ],
               [ "Gloria Little", "Systems Administrator", "New York", "1721", "2009/04/10", "$237,500" ],
               [ "Bradley Greer", "Software Engineer", "London", "2558", "2012/10/13", "$132,000" ],
               [ "Dai Rios", "Personnel Lead", "Edinburgh", "2290", "2012/09/26", "$217,500" ],
               [ "Jenette Caldwell", "Development Lead", "New York", "1937", "2011/09/03", "$345,000" ],
               [ "Yuri Berry", "Chief Marketing Officer (CMO)", "New York", "6154", "2009/06/25", "$675,000" ],
               [ "Caesar Vance", "Pre-Sales Support", "New York", "8330", "2011/12/12", "$106,450" ],
               [ "Doris Wilder", "Sales Assistant", "Sidney", "3023", "2010/09/20", "$85,600" ],
               [ "Angelica Ramos", "Chief Executive Officer (CEO)", "London", "5797", "2009/10/09", "$1,200,000" ],
               [ "Gavin Joyce", "Developer", "Edinburgh", "8822", "2010/12/22", "$92,575" ],
               [ "Jennifer Chang", "Regional Director", "Singapore", "9239", "2010/11/14", "$357,650" ],
               [ "Brenden Wagner", "Software Engineer", "San Francisco", "1314", "2011/06/07", "$206,850" ],
               [ "Fiona Green", "Chief Operating Officer (COO)", "San Francisco", "2947", "2010/03/11", "$850,000" ],
               [ "Shou Itou", "Regional Marketing", "Tokyo", "8899", "2011/08/14", "$163,000" ],
               [ "Michelle House", "Integration Specialist", "Sidney", "2769", "2011/06/02", "$95,400" ],
               [ "Suki Burks", "Developer", "London", "6832", "2009/10/22", "$114,500" ],
               [ "Prescott Bartlett", "Technical Author", "London", "3606", "2011/05/07", "$145,000" ],
               [ "Gavin Cortez", "Team Leader", "San Francisco", "2860", "2008/10/26", "$235,500" ],
               [ "Martena Mccray", "Post-Sales support", "Edinburgh", "8240", "2011/03/09", "$324,050" ],
               [ "Unity Butler", "Marketing Designer", "San Francisco", "5384", "2009/12/09", "$85,675" ]
           ];

           $(document).ready(function() {
               $('#example').DataTable( {
                   data: dataSet,
                   columns: [
                       { title: "Name" },
                       { title: "Position" },
                       { title: "Office" },
                       { title: "Extn." },
                       { title: "Start date" },
                       { title: "Salary" }
                   ]
               } );
           } );
       </script>
    </body>
</html>
